import telebot
import yt_dlp
import os
import logging

# Xatolarni qayd qilish
logging.basicConfig(level=logging.INFO)

TOKEN = '8584554183:AAEd6P9p6HfpK_p_kaPmcyOetMS4nwxm2-Q'
bot = telebot.TeleBot(TOKEN)

# Yuklash va Qidirish funksiyasi
def download_media(query, mode='link'):
    if not os.path.exists('downloads'):
        os.makedirs('downloads')

    # Agar foydalanuvchi nom yozsa, YouTube'dan qidiradi
    search_query = query if mode == 'link' else f"ytsearch1:{query}"
    
    # Video sozlamalari
    v_opts = {
        'format': 'best[ext=mp4]/best',
        'outtmpl': 'downloads/%(title)s.%(ext)s',
        'quiet': True,
        'no_warnings': True,
    }

    # Audio sozlamalari (320kbps)
    a_opts = {
        'format': 'bestaudio/best',
        'outtmpl': 'downloads/%(title)s.mp3',
        'postprocessors': [{
            'key': 'FFmpegExtractAudio',
            'preferredcodec': 'mp3',
            'preferredquality': '320',
        }],
        'quiet': True,
        'no_warnings': True,
    }

    try:
        with yt_dlp.YoutubeDL(v_opts) as ydl:
            info = ydl.extract_info(search_query, download=True)
            # Agar qidiruv bo'lsa, birinchi natijani oladi
            if 'entries' in info:
                info = info['entries'][0]
            v_file = ydl.prepare_filename(info)
            title = info.get('title', 'Media')

        # Audioni tayyorlash
        with yt_dlp.YoutubeDL(a_opts) as ydl:
            ydl.download([info['webpage_url']])
            a_file = os.path.splitext(v_file)[0] + ".mp3"
            
        return v_file, a_file, title
    except Exception as e:
        logging.error(f"Xato yuz berdi: {e}")
        return None, None, None

@bot.message_handler(commands=['start'])
def start(message):
    bot.reply_to(message, "Salom Shukrulla! üöÄ\n\nMen nimalar qila olaman:\n"
                          "1. Instagram, YouTube, TikTok linkidan video yuklash.\n"
                          "2. Videoning audiosini HQ formatda yuborish.\n"
                          "3. Musiqa nomini yozsangiz, uni topib berish.")

@bot.message_handler(func=lambda m: True)
def handle_message(message):
    text = message.text
    status = bot.reply_to(message, "üîç Jarayon bajarilmoqda, kuting...")

    # Link yoki Nom ekanligini aniqlash
    mode = 'link' if text.startswith("http") else 'search'
    
    v_path, a_path, title = download_media(text, mode)

    if a_path and os.path.exists(a_path):
        try:
            # Agar bu shunchaki musiqa qidiruvi bo'lsa, faqat audio yuboramiz
            if mode == 'search':
                with open(a_path, 'rb') as a:
                    bot.send_audio(message.chat.id, a, caption=f"üéµ {title}\nüîé Topildi!")
            else:
                # Link bo'lsa, ham video ham audio yuboramiz
                with open(v_path, 'rb') as v:
                    bot.send_video(message.chat.id, v, caption=f"üé¨ {title}")
                with open(a_path, 'rb') as a:
                    bot.send_audio(message.chat.id, a, caption=f"üéß Audiosi (320kbps)")

            bot.delete_message(message.chat.id, status.message_id)
        except Exception as e:
            bot.edit_message_text(f"‚ùå Yuborishda xato: {e}", message.chat.id, status.message_id)
        finally:
            if v_path and os.path.exists(v_path): os.remove(v_path)
            if a_path and os.path.exists(a_path): os.remove(a_path)
    else:
        bot.edit_message_text("‚ùå Hech narsa topilmadi. Link yoki nomni tekshiring.", message.chat.id, status.message_id)

if __name__ == "__main__":
    bot.infinity_polling()
